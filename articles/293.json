{
  "id": "293",
  "title": "两种方式手写实现Promise（基本版）",
  "keywords": [
    "promise",
    "javascript",
    "JS"
  ],
  "content": "<h1>Promise / deferred 分开的版本</h1>\n\n<pre><code>&#39;use strict&#39;;\nlet myPromise = (deferred) =&gt; {\n  this._resolved = null;\n  this._rejected = null;\n  this.then = (resolve,reject) =&gt; {\n    switch (deferred.state){\n      case &#39;pending&#39;:\n        this._resolved = (typeof resolve === &#39;function&#39;) ? \n          resolve \n          : null;\n        this._rejected =  (typeof reject === &#39;function&#39;) ? \n          reject \n          : null;\n        break;\n      case &#39;rejected&#39;:\n        (typeof reject === &#39;function&#39;) \n        &amp;&amp; reject.call(null,deferred.reason);\n        break;\n      case &#39;resolved&#39;:\n        (typeof resolve === &#39;function&#39;) \n        &amp;&amp; resolve.call(null,deferred.result);\n        break;\n    }\n  };\n};\n\nlet myDeferred = () =&gt; {\n  let _self = this;\n  this.state = &#39;pending&#39;;\n  this.reason = null;\n  this.result = null;\n  this.promise = new myPromise(_self);\n\n  this.resolved = (val) =&gt; {\n    this.state = &#39;resolved&#39;;\n    this.result = val;\n    if(this.promise._resolved){\n      this.promise._resolved.call(null,val);\n    }\n  };\n\n  this.rejected = (err) =&gt; {\n    this.state = &#39;rejected&#39;;\n    this.reason = err;\n    if(this.promise._rejected){\n      this.promise._rejected.call(null,err);\n    }\n  };\n};</code></pre>\n\n<h3>USAGE</h3>\n\n<pre><code>const fs = require(&#39;fs&#39;);\nlet getFileSync = function (path) {\n\n  let df = new myDeferred();\n\n  fs.readFile(path, (e, r) =&gt; {\n    if(e){\n \t  df.rejected(e);\n    }else{\n      df.resolved(r);\n    }\n  });\n  return df.promise;\n};\n\nlet r =getFileSync(&#39;./README.md&#39;);\n//pending\nr.then(\n  //resolved\n  (val) =&gt; console.log(val),\n\n  //rejected\n  (err) =&gt; console.log(err)\n);</code></pre>\n\n<h1>一体化的版本</h1>\n\n<pre><code>let myPromise = (fn) =&gt; {\n  let _self = this;\n  this.state = &#39;pending&#39;;\n  this.result = null;\n  this.reason = null;\n  this.resolvedHandler = null;\n  this.rejectedHandler = null;\n\n  this.resolved = (val) =&gt; {\n    _self.state = &#39;resolved&#39;;\n    _self.result = val;\n    if(typeof _self.resolvedHandler === &#39;function&#39;){\n      _self.resolvedHandler(val);\n    }\n  };\n\n  this.rejected = (err) =&gt; {\n    _self.state = &#39;rejected&#39;;\n    _self.reason = err;\n\n    if(typeof _self.rejectedHandler === &#39;function&#39;){\n      _self.rejectedHandler(err);\n    }\n  };\n\n  this._promise = {};\n\n  this._promise._p = _self;\n\n  this._promise.then = (resolvedHandler, rejectedHandler) =&gt; {\n    switch (_self.state){\n      case &#39;pending&#39;:\n    \t_self.resolvedHandler = (typeof resolvedHandler === &#39;function&#39;) ? \n        resolvedHandler \n        : null;\n    \t_self.rejectedHandler = (typeof rejectedHandler === &#39;function&#39;) ? \n        rejectedHandler \n        : null;\n    \tbreak;\n\n      case &#39;resolved&#39;:\n    \t(typeof resolvedHandler === &#39;function&#39;) \n        &amp;&amp; resolvedHandler(_self.result);\n    \tbreak;\n      case &#39;rejected&#39;:\n    \t(typeof rejectedHandler === &#39;function&#39;) \n        &amp;&amp; rejectedHandler(_self.reason);\n    }\n  };\n\n  fn(this.resolved,this.rejected);\n\n  return this._promise;\n};</code></pre>\n\n<h3>USAGE</h3>\n\n<pre><code>const fs = require(&#39;fs&#39;);\n\nlet getFileSync = (path) =&gt; {\n  return new myPromise( (resolved, rejected) =&gt; {\n    fs.readFile(path, (e, r) =&gt; {\n      if(!e){\n        resolved(r);\n      }else{\n        rejected(e);\n      }\n    });\n  });\n};\n\nlet r = getFileSync(&#39;./README.md&#39;);\n//pending\n\nr.then(\n  //resolved\n  (val) =&gt; console.log(val), \n  //rejected\n  (err) =&gt; console.log(err)\n);</code></pre>",
  "createdAt": 1467022560,
  "modified": 1467116983
}